```md
# CoinMax
# 技术系统执行文档（Replit Agent 构建规格）

版本：V1.0  
技术栈：VITE + React + TypeScript + Supabase + Thirdweb  
执行集成：Polymarket + Hyperliquid + One Engine  

---

## 一、系统目标

构建一个包含以下模块的一体化 DApp：

1. 预测市场（真实 + 分流）
2. 金库（真实对接 + 分流自营）
3. AI量化跟单（用户API）
4. 节点制度（大节点 / 小节点）
5. 团队等级与级差分润
6. $CMX 代币与质押
7. 保险池（预留）
8. 分润与结算引擎
9. 风控系统

---

## 二、系统结构

Frontend (Vite + React)
        ↓
Supabase (Postgres + Edge Functions)
        ↓
Execution Layer
    - Polymarket
    - Hyperliquid
    - One Engine

---

## 三、双结构模型（必须实现）

所有交易与金库必须支持：

### 模式字段：execution_mode

ENUM:
- EXTERNAL
- INTERNAL

#### EXTERNAL
- 可开关真实对接
- 数据同步展示

#### INTERNAL
- 分流自营
- 收益由平台结算引擎计算
- 必须记录策略分配比例

---

## 四、产品参数（核心参数总表）

### 1）金库参数

最低参与金额：
- MIN_VAULT_AMOUNT = 50 USDT

周期收益参数：
- VAULT_PLAN = {
  5_DAYS: { daily_rate: 0.005 },
  15_DAYS: { daily_rate: 0.007 },
  45_DAYS: { daily_rate: 0.009 }
}

提前赎回扣除：
- EARLY_EXIT_PENALTY = 0.10

结算时间：
- SETTLEMENT_TIME = 12:00 UTC+8

---

### 2）AI量化分润参数

利润分配模型：
- USER_SHARE = 0.70
- CREATOR_SHARE = 0.20
- PLATFORM_SHARE = 0.10

推荐奖励（来自平台分成）：
- DIRECT_REFERRAL = 0.10

---

### 3）节点制度参数

大节点（MAX NODE）：
- NODE_MAX = {
  amount: 6000,
  duration_days: 120,
  fixed_return: 0.10,
  daily_rate_reference: 0.009,
  market_rank_unlock: "V6",
  revenue_pool_share: 0.50
}

小节点（MINI NODE）：
- NODE_MINI = {
  amount: 1000,
  duration_days: 90,
  fixed_return: 0.10,
  daily_rate_reference: 0.009,
  market_rank_unlock: "V4"
}

---

### 4）团队等级参数

- RANKS = [
 { level: "V1", personal:100, team:5000, commission:0.06 },
 { level: "V2", personal:100, team:20000, commission:0.10 },
 { level: "V3", personal:100, team:50000, commission:0.15 },
 { level: "V4", personal:100, team:100000, commission:0.20 },
 { level: "V5", personal:1000, team:500000, commission:0.25 },
 { level: "V6", personal:1000, team:1000000, commission:0.30 },
 { level: "V7", personal:1000, team:3000000, commission:0.50 }
]

---

## 五、数据库结构（必须完整实现）

### 1）用户表

profiles
- id
- wallet_address
- ref_code
- referrer_id
- rank
- node_type
- created_at

---

### 2）账户体系

accounts
- id
- user_id
- type (spot / vault / strategy / bonus)
- currency

---

### 3）账本

ledger_entries
- id
- account_id
- tx_type
- amount
- ref_type
- ref_id
- created_at

---

### 4）金库

vault_positions
- id
- user_id
- plan_type
- execution_mode
- principal
- start_date
- end_date
- status

---

### 5）量化订阅

strategy_subscriptions
- id
- user_id
- strategy_id
- execution_mode
- allocated_capital
- max_drawdown
- status

---

### 6）节点

node_memberships
- id
- user_id
- node_type
- start_date
- end_date
- status

---

### 7）团队关系

referral_tree
- user_id
- parent_id
- depth

---

## 六、结算引擎逻辑

### 1）金库收益计算

- profit = principal × daily_rate × duration_days

提前退出：
- refund = principal × (1 - EARLY_EXIT_PENALTY)

---

### 2）量化分润

- net_profit = total_profit - total_loss
- user_profit = net_profit × USER_SHARE
- creator_profit = net_profit × CREATOR_SHARE
- platform_profit = net_profit × PLATFORM_SHARE

---

### 3）团队级差计算

- commission = 下级利润 × (当前等级比例 - 下级等级比例)

---

## 七、风控触发规则

最大回撤触发：
- if current_drawdown >= max_drawdown:
    - suspend_subscription
    - log risk_event

API权限校验：
- 禁止提现权限

预测赔率异常：
- if odds_change > threshold:
    - freeze_market

---

## 八、$CMX 机制

用途：
1. 节点升级
2. 佣金奖励
3. 手续费折扣
4. 保险额度提升
5. 回购销毁机制

回购规则：
- 20% platform_fee → buyback CMX → burn

---

## 九、任务分解给 Replit Agent

必须生成：
1. 前端路由结构
2. Supabase migration 文件
3. Edge Functions
4. Mock Provider 层
5. 结算 Cron 任务
6. Rank 自动升级服务
7. Node 到期检测服务

---

## 十、上线顺序

阶段1：
- 钱包登录
- 金库
- 推荐系统

阶段2：
- AI量化
- 节点系统
- 团队级差

阶段3：
- CMX代币
- 回购销毁
- DAO

---

## 十一、重要说明（工程限制）

1. 所有收益必须记录 ledger_entries
2. 所有分润必须通过 payout_batch
3. 所有风险事件必须写入 risk_events

---

## 十二、系统核心参数配置表（必须实现为 Config 表）

所有参数必须可在数据库中配置，不允许写死在代码中。

### 1）全局基础参数

- PLATFORM_CURRENCY = "USDT"
- DECIMAL_PRECISION = 6
- MIN_WITHDRAW_AMOUNT = 10
- WITHDRAW_FEE = 0.01
- SETTLEMENT_CRON = "0 12 * * *" (UTC+8)

---

### 2）金库结构占比参数（双结构）

- VAULT_STRUCTURE_RATIO = {
   EXTERNAL: 0.60,
   INTERNAL: 0.40
}

---

### 3）INTERNAL 分流资金再分配比例

- INTERNAL_ALLOCATION = {
   AI_STRATEGY_POOL: 0.50,
   HEDGE_POOL: 0.20,
   LIQUIDITY_POOL: 0.20,
   INSURANCE_POOL: 0.10
}

---

### 4）平台收入分配比例

平台收入来源：
- 预测手续费
- 金库管理费
- 量化分润
- 提现手续费

收入分配：
- PLATFORM_REVENUE_DISTRIBUTION = {
   NODE_POOL: 0.50,
   BUYBACK_POOL: 0.20,
   INSURANCE_POOL: 0.10,
   TREASURY_POOL: 0.10,
   OPERATIONS: 0.10
}

---

### 5）节点收益来源结构

大节点收益来源：
- NODE_MAX_PROFIT_SOURCE = {
   MARKET_FEE_SHARE: 0.50,
   VAULT_PROFIT: 0.30,
   STRATEGY_PROFIT: 0.20
}

小节点收益来源：
- NODE_MINI_PROFIT_SOURCE = {
   MARKET_FEE_SHARE: 0.40,
   VAULT_PROFIT: 0.40,
   STRATEGY_PROFIT: 0.20
}

---

### 6）团队级差计算强化规则

- MAX_DEPTH = 15
- LEVEL_DIFFERENCE_MODE = "DIFF_ONLY"

计算方式：
- if superior_level > subordinate_level:
    - commission = subordinate_profit × (superior_rate - subordinate_rate)

---

### 7）自动升级规则参数

- RANK_EVALUATION_CRON = "0 0 * * *"
- RANK_REQUIREMENTS = {
   MIN_ACTIVE_MEMBERS = 3,
   TEAM_VOLUME_EXCLUDE_SELF = true
}

---

### 8）节点到期规则

- NODE_EXPIRE_AUTO_DOWNGRADE = true
- NODE_GRACE_PERIOD_DAYS = 3

---

### 9）风控阈值参数

- MAX_DRAWDOWN_LIMIT = 0.30
- ODDS_CHANGE_THRESHOLD = 0.15
- MAX_SINGLE_POSITION = 0.20
- MAX_LEVERAGE = 5

---

### 10）保险池参数

- INSURANCE_TRIGGER = 0.25
- INSURANCE_COVERAGE_MAX = 0.50

---

### 11）$CMX 代币参数

- TOTAL_SUPPLY = 100000000
- BUYBACK_PERCENT = 0.20
- BURN_PERCENT = 0.50
- STAKING_BOOST = {
   TIER1: 1.05,
   TIER2: 1.10,
   TIER3: 1.20
}

---

### 12）分润批次参数

- PAYOUT_BATCH_MODE = "DAILY"
- MIN_PAYOUT_AMOUNT = 5

所有分润必须生成：
- payout_batches
- payout_items

---

### 13）资金安全约束

- MIN_LIQUIDITY_RESERVE = 0.15
- MAX_INTERNAL_EXPOSURE = 0.50

---

## 十三、数据库新增配置表（必须实现）

system_config
- key
- value
- updated_at

revenue_pools
- pool_name
- balance

risk_parameters
- name
- value

---

## 十四、完整资金流模型

用户入金
   ↓
进入 Vault / Strategy
   ↓
产生利润
   ↓
抽取平台费
   ↓
收入分配：
   - 节点池
   - 回购池
   - 保险池
   - DAO
   - 运营
   ↓
节点按等级分配
   ↓
团队级差发放
   ↓
记录 ledger_entries

---

## 十五、崩盘防护参数（必须存在）

- IF revenue_pool < required_node_payout:
    - reduce_node_yield_rate
    - freeze_new_node_sales

- IF internal_drawdown > MAX_DRAWDOWN_LIMIT:
    - auto_switch_to_external_mode
```
